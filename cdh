#!/bin/bash
#
# Author: louisadunne@gmail.com
# Sun Mar 10 16:50:24 GMT 2013
#
# A few commands for keeping track of cd history

# TODO add file support for persistence

alias   cd=cdh-cd
alias   cdh=cdh-history
alias   cdcl=cdh-clear

if [ "$CDHISTORY" == "" ]; then
    CDHISTORY=()
    CDINDEX=-1
fi

cdh-cd()
{
    local dir index

    if [ "$1" == "" ]; then
        dir=~
    elif [[ $1 =~ ^[0-9]+ ]] || [[ $1 =~ ^-[0-9]+ ]]; then
        cdh-get-index $1
        if [ $? -eq 0 ] && [ ! -d $1 ]; then
            \cd ${CDHISTORY[$index]}
            return 0
        fi

        dir="$1"
    else
        dir="$1"
    fi

    \cd "$dir" || return 1

    # Don't add the dir if it's already in the list
    if [ $PWD == ~ ]; then
        # No point putting home dir into history
        return 0
    fi

    for ((index = 0; index < ${#CDHISTORY[@]}; index++)); do
        if [ "$PWD" == "${CDHISTORY[$index]}" ]; then
            return 0
        fi
    done

    # Save it in the history - use $PWD not $1 since cdspell may be active
    ((CDINDEX++))
    CDHISTORY[$CDINDEX]=$PWD
    return 0
}

cdh-history()
{
    local index

    if [ "$CDHISTORY" == "" ]; then
        echo "<empty>"
        return 0
    else
        cdh-get-index $1 || return 1
    fi

    if [ $index == -1 ]; then
        for ((index = 0; index < ${#CDHISTORY[@]}; index++)); do
            echo "${index}:${CDHISTORY[$index]} "
        done
        return
    else
        echo ${CDHISTORY[$index]}
    fi

    return 0
}

cdh-clear()
{
    local index tmp

    if [ "$CDHISTORY" == "" ]; then
        return 0
    fi

    cdh-get-index $1 || return 1
    if [ $index == -1 ]; then
        CDHISTORY=()
        CDINDEX=-1
    else
        # unset leaves gaps so copy each element excluding the
        # $index
        tmp=()
        for ((i = 0; i < ${#CDHISTORY[@]}; i++)); do
            if [ $i -ne $index ]; then
                tmp+=(${CDHISTORY[$i]})
            fi
        done
        CDHISTORY=("${tmp[@]}")
        ((CDINDEX--))
    fi

    cdh-history
    return 0
}


cdh-get-index()
{
    if [ "$1" == "-" ]; then
        index=$CDINDEX
    elif [[ $1 =~ ^[0-9]+ ]]; then
        index=$1
    elif [[ $1 =~ -[0-9]+ ]]; then
        index=$(expr ${#CDHISTORY[@]} - $(echo $1 | tr -d '-'))
    elif [ "$1" != "" ]; then
        echo "Unknown arg: $1"
        return 1
    else
        # do all
        index=-1
        return 0
    fi

    if [ $index -lt 0 -o $index -ge ${#CDHISTORY[@]} ]; then
        echo "$1 out of range"
        return 1
    fi

    return 0
}
